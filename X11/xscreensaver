#? -*-perl-*-
#
# xscreensaver - Configuration for XScreenSaver
#
# <? print "\n"; # For syntax highlighting
use warnings;
use strict;

my $CONFIG = <<'EOF';
programs:								      \
				maze -root				    \n\
  GL: 				superquadrics -root			    \n\
				attraction -root			    \n\
				blitspin -root				    \n\
-				greynetic -root				    \n\
-				helix -root				    \n\
-				hopalong -root				    \n\
-				imsmap -root				    \n\
-				noseguy -root				    \n\
-				pyro -root				    \n\
				qix -root				    \n\
				rocks -root -delay 25000		    \n\
				rorschach -root				    \n\
				decayscreen -root			    \n\
-				flame -root				    \n\
-				halo -root				    \n\
				slidescreen -root			    \n\
-				pedal -root				    \n\
-				bouboule -root				    \n\
-				braid -root				    \n\
-				coral -root				    \n\
-				deco -root				    \n\
				drift -root				    \n\
-				fadeplot -root				    \n\
				galaxy -root				    \n\
-				goop -root				    \n\
				grav -root				    \n\
-				ifs -root				    \n\
  GL: 				jigsaw -root				    \n\
-				julia -root				    \n\
				kaleidescope -root			    \n\
  GL: 				moebius -root				    \n\
-				moire -root				    \n\
- GL: 				morph3d -root				    \n\
				mountain -root -delay 5000		    \n\
				munch -root				    \n\
				penrose -root				    \n\
  GL: 				pipes -root				    \n\
-				rd-bomb -root				    \n\
  GL: 				rubik -root -hideshuffling		    \n\
-				sierpinski -root			    \n\
-				slip -root				    \n\
  GL: 				sproingies -root			    \n\
-				starfish -root				    \n\
				strange -root				    \n\
-				swirl -root				    \n\
				triangle -root				    \n\
				xjack -root				    \n\
-				xlyap -root				    \n\
  GL: 				atlantis -root				    \n\
				bsod -root				    \n\
- GL: 				bubble3d -root				    \n\
- GL: 				cage -root				    \n\
-				crystal -root				    \n\
-				cynosure -root				    \n\
-				discrete -root				    \n\
-				distort -root				    \n\
				epicycle -root				    \n\
				flow -root				    \n\
- GL: 				glplanet -root				    \n\
				interference -root			    \n\
				kumppa -root				    \n\
- GL: 				lament -root				    \n\
-				moire2 -root				    \n\
- GL: 				sonar -root				    \n\
  GL: 				stairs -root				    \n\
-				truchet -root				    \n\
-				vidwhacker -root			    \n\
				blaster -root				    \n\
-				bumps -root				    \n\
				ccurve -root				    \n\
-				compass -root				    \n\
				deluxe -root				    \n\
-				demon -root				    \n\
- GL: 				extrusion -root				    \n\
				loop -root				    \n\
				penetrate -root				    \n\
-				petri -root				    \n\
				phosphor -root				    \n\
  GL: 				pulsar -root				    \n\
-				ripples -root				    \n\
-				shadebobs -root				    \n\
  GL: 				sierpinski3d -root			    \n\
-				spotlight -root				    \n\
				squiral -root				    \n\
				wander -root				    \n\
-				webcollage -root			    \n\
-				xflame -root				    \n\
-				xmatrix -root -mode hex -no-trace	      \
				  -no-knock-knock			    \n\
  GL: 				gflux -root				    \n\
-				nerverot -root				    \n\
				xrayswarm -root				    \n\
				xspirograph -root			    \n\
  GL: 				circuit -root				    \n\
- GL: 				dangerball -root			    \n\
- GL: 				dnalogo -root				    \n\
  GL: 				engine -root				    \n\
- GL: 				flipscreen3d -root			    \n\
  GL: 				gltext -root				    \n\
  GL: 				menger -root				    \n\
  GL: 				molecule -root				    \n\
-				rotzoomer -root				    \n\
				speedmine -root				    \n\
  GL: 				starwars -root -font '-*-helvetica-*-r-*-*-34-*' \n\
  GL: 				stonerview -root			    \n\
-				vermiculate -root			    \n\
-				whirlwindwarp -root			    \n\
				zoom -root				    \n\
-				anemone -root				    \n\
				apollonian -root			    \n\
- GL: 				boxed -root				    \n\
- GL: 				cubenetic -root				    \n\
  GL: 				endgame -root				    \n\
				euler2d -root				    \n\
				fluidballs -root			    \n\
  GL: 				flurry -root				    \n\
- GL: 				glblur -root				    \n\
  GL: 				glsnake -root				    \n\
				halftone -root				    \n\
  GL: 				juggler3d -root				    \n\
- GL: 				lavalite -root				    \n\
-				polyominoes -root			    \n\
  GL: 				queens -root				    \n\
- GL: 				sballs -root				    \n\
- GL: 				spheremonics -root			    \n\
-				thornbird -root				    \n\
-				twang -root				    \n\
- GL: 				antspotlight -root			    \n\
-				apple2 -root				    \n\
  GL: 				atunnel -root				    \n\
				barcode -root -mode grid		    \n\
  GL: 				blinkbox -root				    \n\
  GL: 				blocktube -root -wireframe		    \n\
  GL: 				bouncingcow -root			    \n\
-				cloudlife -root				    \n\
- GL: 				cubestorm -root				    \n\
-				eruption -root				    \n\
  GL: 				flipflop -root				    \n\
  GL: 				flyingtoasters -root			    \n\
				fontglide -root				    \n\
  GL: 				gleidescope -root			    \n\
- GL: 				glknots -root				    \n\
- GL: 				glmatrix -root				    \n\
- GL: 				glslideshow -root			    \n\
  GL: 				hypertorus -root			    \n\
- GL: 				jigglypuff -root			    \n\
-				metaballs -root				    \n\
- GL: 				mirrorblob -root			    \n\
				piecewise -root				    \n\
  GL: 				polytopes -root				    \n\
				pong -root -clock			    \n\
				popsquares -root -fg #8C0000		    \n\
  GL: 				surfaces -root				    \n\
				xanalogtv -root				    \n\
-				abstractile -root			    \n\
				anemotaxis -root			    \n\
- GL: 				antinspect -root			    \n\
				fireworkx -root				    \n\
-				fuzzyflakes -root			    \n\
				interaggregate -root			    \n\
				intermomentary -root			    \n\
				memscroller -root			    \n\
  GL: 				noof -root				    \n\
				pacman -root				    \n\
- GL: 				pinion -root				    \n\
  GL: 				polyhedra -root				    \n\
- GL: 				providence -root			    \n\
				substrate -root				    \n\
				wormhole -root				    \n\
- GL: 				antmaze -root				    \n\
- GL: 				boing -root				    \n\
-				boxfit -root				    \n\
  GL: 				carousel -root				    \n\
-				celtic -root				    \n\
  GL: 				crackberg -root				    \n\
- GL: 				cube21 -root				    \n\
				fiberlamp -root				    \n\
  GL: 				fliptext -root				    \n\
  GL: 				glhanoi -root				    \n\
  GL: 				tangram -root				    \n\
- GL: 				timetunnel -root			    \n\
  GL: 				glschool -root				    \n\
  GL: 				topblock -root				    \n\
  GL: 				cubicgrid -root				    \n\
				cwaves -root				    \n\
- GL: 				gears -root				    \n\
- GL: 				glcells -root				    \n\
  GL: 				lockward -root				    \n\
-				m6502 -root				    \n\
  GL: 				moebiusgears -root			    \n\
  GL: 				voronoi -root				    \n\
  GL: 				hypnowheel -root			    \n\
  GL: 				klein -root				    \n\
-				lcdscrub -root				    \n\
- GL: 				photopile -root				    \n\
  GL: 				skytentacles -root			    \n\
- GL: 				rubikblocks -root			    \n\
  GL: 				companioncube -root			    \n\
  GL: 				hilbert -root				    \n\
- GL: 				tronbit -root				    \n\
-				unicode -root				    \n\


EOF
# Blank lines at end of data

# Read customizations from this file
my %override = ();
my $cont = '';
use DB;
while ( $CONFIG =~ m/(.*\n)/g ) {
    my $line = $_ = $1;
    if ( $cont ) { $_ = $cont . $_ }
    elsif ( m/^[#!;]|^\s*$/ ) { next }
    if ( $line =~ m/\S/ && m/\\\s*$/ ) { $cont = $_; next }
    m/^(\w+):/ or die "xscreensaver parse error";
    $override{$1} = $_;
    $cont = '';
}
die "Parse error: still stuff in \$cont" if $cont;
# Merge with existing XScreenSaver configuration
if ( open F, '<', "$ENV{HOME}/.xscreensaver" ) {
    my $skipping = 1;
    foreach (<F>) {
        next if $skipping && m/^#/ && !m/XScreenSaver Preferences File/;
        $skipping = 0;
        my $line = $_;
        if ( $cont ) { $_ = $cont . $_ }
        elsif ( m/^[#!;]|^\s*$/ ) { print unless m/^#\?|not inherited/; next }
        if ( $line =~ m/\S/ && m/\\\s*$/ ) { $cont = $_; next }
        m/^(\w+):/ or die "xscreensaver parse error";
        if ( exists($override{$1}) ) {
            print "# '$1' is not inherited from the local configuration\n";
            $_ = $override{$1};
            delete $override{$1};
        }
        print;
        $cont = '';
    }
    print values %override;
    close F;
    print "#? install ~/.xscreensaver\n";
}
else { warn "Can't read ~/.xscreensaver for customization: $!\n" }

# FIXME: don't duplicate ~/.xscreensaver parse loop
